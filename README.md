# HW2023Project

### 项目意图

2023华为软件精英挑战赛决赛赛题（华为云智能机器人调度问题+对抗模式）
决赛练习赛赛题（含任务书）：﻿https://bbs.huaweicloud.com/forum/thread-0298116469469619076-1-1.html

### 版本信息
【Version】：final.3.1.16
【Version Notes】：决赛正赛最终版
【Date & Time】：2023/04/22 11:42
【Project Team】：武长赛区 铁道游击队2023
【Latest Update By】：XYX


<!-- TOC depthFrom:1 depthTo:6 withLinks:1 updateOnSave:1 orderedList:0 -->

- [HW2023Project](#hw2023project)
		- [项目意图](#项目意图)
		- [版本信息](#版本信息)
		- [系统环境参数](#系统环境参数)
	- [工程文件目录结构](#工程文件目录结构)
			- [HW2023Project](#hw2023project)
			- [--- Main.h/.cpp](#-mainhcpp)
			- [--- Global.h/.cpp](#-globalhcpp)
			- [--- Readin.h/.cpp](#-readinhcpp)
			- [--- Map.h/.cpp](#-maphcpp)
			- [--- Defend.h/.cpp](#-defendhcpp)
			- [--- Schedule.h/.cpp](#-schedulehcpp)
			- [--- Attack.h/.cpp](#-attackhcpp)
			- [--- Path.h/.cpp](#-pathhcpp)
			- [--- Motion.h/.cpp](#-motionhcpp)
			- [--- Out.h/.cpp](#-outhcpp)
			- [--- Calculate.h/.cpp](#-calculatehcpp)
	- [谨记！](#谨记)
		- [* 地图边界条件防数组越界！！！！](#-地图边界条件防数组越界)
		- [* 状态轮异常状态记得捕获与复位！！！](#-状态轮异常状态记得捕获与复位)
	- [算法核心](#算法核心)
		- [初始化](#初始化)
			- [Main.h >> void init();](#mainh-void-init)
		- [实时](#实时)
			- [Main.h >> main() >> while(){};](#mainh-main-while)
				- [一、 雷达索敌与危险站确定 scouting(); -> Defend.cpp](#一-雷达索敌与危险站确定-scouting-defendcpp)
					- [雷达索敌](#雷达索敌)
					- [危险站确定](#危险站确定)
				- [二、 调度策略（调度状态轮转）state_wheel(); -> Schedule.cpp](#二-调度策略调度状态轮转statewheel-schedulecpp)
					- [卖出避险](#卖出避险)
					- [卖出行为](#卖出行为)
					- [关键路径调度](#关键路径调度)
					- [贪婪调度](#贪婪调度)
					- [买入行为](#买入行为)
				- [三、 攻击策略（攻击者状态轮转）attack_wheel(); -> Attacker.cpp](#三-攻击策略攻击者状态轮转attackwheel-attackercpp)
					- [攻击点分配](#攻击点分配)
					- [攻击点守卫](#攻击点守卫)
					- [攻击角落站的特殊逻辑](#攻击角落站的特殊逻辑)
				- [四、 实时路径规划 path_search(); -> Path.cpp](#四-实时路径规划-pathsearch-pathcpp)
				- [五、 避障（安全点搜索与冲突避让决策）avoid(); -> Path.cpp](#五-避障安全点搜索与冲突避让决策avoid-pathcpp)
				- [六、 运动控制 move(); -> Motion.cpp](#六-运动控制-move-motioncpp)
		- [Update Record 版本迭代提要](#update-record-版本迭代提要)

<!-- /TOC -->

### 系统环境参数

C/C++ 编译环境：
make：GNU Make 4.1
cmake：cmake version 3.22.0
gcc：gcc7.3.0
g++: g++7.3.0

## 工程文件目录结构

####HW2023Project
####--- Main.h/.cpp
&emsp;&emsp; 主函数（GAME初始化+每帧动作）
####--- Global.h/.cpp
&emsp;&emsp; 核心全局变量（state+可调参数）
####--- Readin.h/.cpp
&emsp;&emsp; 数据接收（初始化读入+每帧读入）
####--- Map.h/.cpp
&emsp;&emsp; 地图信息处理
####--- Defend.h/.cpp
&emsp;&emsp; 防御机制（对敌人位置的判断+危险站点预警）
####--- Schedule.h/.cpp
&emsp;&emsp; 调度算法（关键路径算法+贪心算法）
####--- Attack.h/.cpp
&emsp;&emsp; 攻击者动作
####--- Path.h/.cpp
&emsp;&emsp; 寻路算法（泛洪+A*）
####--- Motion.h/.cpp
&emsp;&emsp; 运动控制
####--- Out.h/.cpp
&emsp;&emsp; 输出指令
####--- Calculate.h/.cpp
&emsp;&emsp; 通用运算（几何运算与坐标切换）

## 谨记！

### * 地图边界条件防数组越界！！！！
### * 状态轮异常状态记得捕获与复位！！！
尤其是跳帧可能导致的卖出失败！！！

## 算法核心

### 初始化
#### Main.h >> void init();
① 基本参数初始化
② 地图类型识别与地图构建 -> Map.cpp
③ 站点配对（包含站点对权重计算） -> Schedule.cpp
④ 运动控制PID初始化 -> Motion.cpp
⑤ 功防关键节点的判断、攻击点搜索、攻击者选取 -> Attack.cpp

### 实时
#### Main.h >> main() >> while(){};
##### 一、 雷达索敌与危险站确定 scouting(); -> Defend.cpp
###### 雷达索敌
* 根据雷达信息，聚类得到当前帧可视敌方机器人位置。
* 将本帧敌方机器人位置与历史敌方机器人位置对比，更新历史敌方机器人/新建敌方机器人。
* 销毁超时敌方机器人。
* 销毁历史位置已空的敌方机器人。
###### 危险站确定
* 蓝方：&emsp;被两个敌方机器人占领的站? 危险站! <br/> &emsp;&emsp;&emsp;&emsp;被一个敌方机器人占领的角落站？危险站！
* 红方：&emsp;被一个敌方机器人占领的站? 危险站!
* 超时重置危险站（很久没有看到危险站了，取消其危险站属性，允许机器人前往）
* 检测重置危险站（看到危险站上没有人了，取消其危险站属性，允许机器人前往）

p.s.蓝色方推力更大，1v1推得动。

##### 二、 调度策略（调度状态轮转）state_wheel(); -> Schedule.cpp
命令形式：cmd[taskStation -> sellStation]。一次买卖视作一次完整指令。
无货状态（取货状态）：cmd.state == 1 &emsp; state.robot.bring == 0
带货状态（运货状态）：cmd.state == 2 &emsp; state.robot.bring > 0

【思路】：
① 卖出避险
② 尝试卖货
③ 关键路径调度
④ 贪婪调度
⑤ 尝试买货

买不了会导致很大的损失，所以优先解决无法卖货的机器人的问题。
为了在同一帧内完成卖、买，设计了卖货->调度->买入的流程。
关键路径调度是为了尽快地完成7（这一收益很高），在没有7或所有7都在生产中时，补充执行贪婪调度。

###### 卖出避险
考虑：机器人在买入后发现卖出地被占领。
* 搜索并卖到其它可卖的站点。
* 超时销毁货物。

###### 卖出行为

若机器人带货到达指定卖出站，尝试卖出。

###### 关键路径调度
* 搜索制作流程的关键路径（自上而下89-7-456-123）。
目标：尽快地补齐生产7所需的原料，尽快地完成7。
首先，优先卖出7。
其次，考虑生产7所缺的材料（为价值最高、缺货最少的7站优先补全）。
如工作台7缺少4，则4->7成为关键路径；如果4进一步地缺少1，则1->4成为关键路径
* 关键路径调度
将关键路径根据优先级，依序分配给最合适（距离）的无货机器人。

###### 贪婪调度
* 计算所有可选指令的效益。
（买卖直接收益+由下一级产品价值计算的综合预期收益）/（跑动距离+路径形状惩罚）
 综合预期收益受下一级产品缺货情况影响，已获得的原料越多，填充此原料的价值越高（让下一级产品尽快生产）。
* 将收益最高的指令分配给无货机器人。
* 指令间存在冲突：不可去相同站取货、不能将同类产品卖到相同站。
* 先进行虚拟调度，若发现指令冲突，以综合收益最高为目标更换冲突指令；
在没有冲突后对机器人下达指令。

###### 买入行为

若机器人带货到达指定买入站，尝试买入。

##### 三、 攻击策略（攻击者状态轮转）attack_wheel(); -> Attacker.cpp

###### 攻击点分配
* 根据节点位置和产品综合计算节点攻击优先序。
* 优先攻击高价值站、角落站（能把人卡在里边）。
* 根据优先序分配攻击点。

若长时间没有敌方机器人接近攻击站（超时）：
* 跟随最近的一个敌方机器人，直到被带到一个高价值站附近。
* 再等待一段时间后，依旧看不到敌方机器人，则根据攻击优先序选择次优先攻击节点。

###### 攻击点守卫
* 将攻击点设置为目标点，前往。
* 到达攻击站后，怼所有路过的敌方机器人。在有多个敌方机器人靠近时，选取离站点最近的一个，直接怼上去。
* 敌方机器人远离后，回退攻击点。

###### 攻击角落站的特殊逻辑
若攻击站为角落站
* 红方：直接缩到站所在的角落内，顶住墙角。
机器人卡在这里，敌方机器人就不可能在此站完成交易。
但是敌方看到你在这，一般不会来买卖。
* 蓝方：蹲守到站的对角，等待敌方机器人前来买卖，把敌方机器人壁咚在墙角。
敌方很难提防，但是由于摩擦力小，壁咚卡死有失败的概率。

###### 追击模式
有些图由于同类站点过多，蹲点策略会显得无效，因此提供纯追击模式，每个机器人朝着最近的敌方机器人直接冲刺。

##### 四、 实时路径规划 path_search(); -> Path.cpp

由于带货态机器人半径为0.53，无货态机器人半径为0.46。
带货态机器人至少需要3格空间，而无货机器人需要2格空间。

针对带货机器人：
* 将墙壁向外扩展一格建立虚拟墙壁（为机器人预留自身所占空间）
* 机器人路径规划于格子中心的连线。
* 这样使得机器人中心远离墙壁0.75m
* 带货机器人跑的这张图被称为expandWall[100][100]

针对无货机器人：
* 机器人路径规划于格子四角的连线（同样也是为机器人预留自身所占的空间）。
* 这样使得机器人中心远离墙壁0.50m
* 无货机器人跑的这张图被称为chessBoard[101][101]
* （很像棋盘对吧）

连通性检验：泛洪 flood();

寻路算法：A* A_star_search();

路径简化：path_simple();

注： 敌方机器人能躲避就躲避（把敌方机器人当墙考虑）；躲开没有路了，视作躲不开，就直接冲。

##### 五、 避障（安全点搜索与冲突避让决策）avoid(); -> Path.cpp

针对机器人a，用广度优先算法搜索一个最近的不是b,c,d路径的点作为a的安全点/避让点。
注意，在搜索时考虑墙和机器人所占空间。

若a站在b的路径上，且b站在a的路径上，视作路径互锁。
让任务价值更低的机器人主动前往安全点，让开路。如果价值相同，则由安全点更近的机器人让路。

##### 六、 运动控制 move(); -> Motion.cpp

* PID 速度控制+角度控制，控制机器人前往路径中的下一个点。
* 结合人工势场法局部避障，对PID的输出进行修正。

### Update Record 版本迭代提要

此为正式赛提交版本，版本更新摘要：略
